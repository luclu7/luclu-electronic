<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width">
		

		<title>Confinement, Train Simulator et STM32: partie 1, la VA</title>

		
		<link rel="stylesheet" href="https://luclu7.fr/blog/css/colors-gray.min.719642165966f4b324a9ae1755882ec0cb43c76471ba0f1cda94e9271fed85ce.css">

		
	</head>
	<body>
		<header id="header">
			<h1><a href="https://luclu7.fr/blog">Projets plus ou moins stupides</a></h1>
			<p>Parfois je fais des trucs intéressants</p>
		</header>

		<div id="page">
			<div id="sidebar">
				<nav>
	
		<ul class="nav">
			
				<li><a href="/blog/index.xml"><span>Flux RSS</span></a></li>
			
				<li><a href="https://github.com/luclu7"><span>Github</span></a></li>
			
		</ul>
	
		<ul class="nav">
			
				<li><a href="https://twitter.com/luclu7__"><span>Twitter</span></a></li>
			
		</ul>
	
</nav>

			</div>

			<div id="content">
				
	<article class="post">
		<h1><a href="https://luclu7.fr/blog/post/ts-part1/">Confinement, Train Simulator et STM32: partie 1, la VA</a> </h1>

		<div class="post-content"><h1 id="le-contexte">Le contexte</h1>
<p>C&rsquo;était le confinement, vers mi-2020. À l&rsquo;époque où tout sur AliExpress ne coûtait pas encore un prix ridicule, à l&rsquo;époque où on pouvait acheter un module STM32F103(C8T6) avec USB type C pour&hellip; 1€60 !
<img src="/blog/img/kvb/aliexpress-1.png" alt="Capture d&amp;rsquo;écran d&amp;rsquo;Aliexpress montrant la commande d&amp;rsquo;un STM32 pour 1€60">
Je suis fan de trains (et donc de <a href="https://store.steampowered.com/app/24010/Train_Simulator_Classic/?l=french">Train simulator</a>) et j&rsquo;avais beaucoup de temps libre, école à distance/hybride oblige. Comme beaucoup de passioné·e·s, je rêve d&rsquo;avoir, un jour, un vrai pupitre (de commande) chez moi, et de pouvoir le connecter à un simulateur ferroviaire (TS, ou surtout OpenRails, comme souvent).
Par exemple:
<a href="https://www.youtube.com/watch?v=fl0SIUiUrc0"><img src="/blog/img/kvb/pupitre-72000-ferrovisim.jpg" alt="Pupitre ce CC 72000, converti par Ferrovisim" title="Pupitre de CC 72000"></a></p>
<p>N&rsquo;ayant pas de pupitre (ça se trouve pas sur leboncoin (quoi que&hellip;)), il existe une autre option: le RailDriver.
<img src="/blog/img/kvb/raildriver.png" alt="Contrôleur RailDriver pour TrainSimulator">
Le seul problème, c&rsquo;est que ça coûte cher, et je ne croule pas sous l&rsquo;argent. Doooonc, la bricole à la rescousse (et puis c&rsquo;est plus intéressant !)</p>
<h1 id="en-pratique">En pratique?</h1>
<p>Donc pour commencer, j&rsquo;ai voulu tenter par un élément simple: la pédale de VA (veille automatique).
Explication rapide: la VA (complet: VACMA, veille automatique à contrôle du maintien d&rsquo;appui) sert à éviter qu&rsquo;en cas de (notamment) malaise conducteur, le train s&rsquo;arrête automatique.</p>
<p>La VA est présente sous différentes formes: une pédale à maintenir appuyée, mais pas plus de 55 secondes. Il faut en effet la relâcher et rappuyer pour prouver qu&rsquo;on est bien conscient. Si le conducteur garde sa pédale enfoncée 55s, une sonnerie se met à sonner. Si au bout de 2.5s il n&rsquo;a pas relâché l&rsquo;appui, le freinage d&rsquo;urgence s&rsquo;engage.</p>
<p>L&rsquo;avantage de commencer par cette partie est qu&rsquo;elle est très simple à implémenter (un seul élément booléen), et qu&rsquo;une pédale est bien plus pratique que la barre espace !</p>
<p>J&rsquo;avais acheté par curiosité une pédale à connecter avant: parfait !
<img src="/blog/img/kvb/p%C3%A9dale.png" alt="Pédale">
<img src="/blog/img/kvb/p%C3%A9dale_avec_connecteur.jpg" alt="Pédale connecteurisée"></p>
<p>Donc côté matériel, c&rsquo;est presque fini. Plus que la connexion avec le logiciel.</p>
<h1 id="la-communication-et-lintégration">La communication et l&rsquo;intégration</h1>
<p>Et c&rsquo;est là qu&rsquo;on a de la chance: grâce au RailDriver précédemment évoqué, il existe une DLL pour s&rsquo;interface &ldquo;facilement&rdquo; avec TS: &ldquo;RailDriver.dll&rdquo; et &ldquo;RailDriver64.dll&rdquo;.</p>
<p>Je saute toute la partie &ldquo;bricoler avec un outils en Java&rdquo; (<a href="https://github.com/reallyinsane/trainsimulator-controller">cet outil</a>), j&rsquo;ai pas réussi à en faire grand chose.</p>
<p>Cependant, il existe un autre language plus pratique que Java: Python !
Malgré que je n&rsquo;aime pas spécialement Python (manque d&rsquo;expérience, j&rsquo;aime pas trop la syntaxe basée sur l&rsquo;indentation, etc), il existe une superbe librairie: <a href="https://github.com/piotrkilczuk/py-raildriver">py-raildriver</a>.</p>
<p>Ainsi, côté Arduino (le STM32F103 précédent, quand il était encore vivant) en série, j&rsquo;envoie simplement un 0 ou un 1, suivi d&rsquo;un LF (\n, retour à la ligne), et côté client (sur le PC):</p>
<p><div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#719e07">from</span> serial <span style="color:#719e07">import</span> <span style="color:#719e07">*</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> raildriver
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> configparser
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rd <span style="color:#719e07">=</span> raildriver<span style="color:#719e07">.</span>RailDriver()
</span></span><span style="display:flex;"><span>rd<span style="color:#719e07">.</span>set_rail_driver_connected(<span style="color:#cb4b16">True</span>)  <span style="color:#586e75"># start data exchange</span>
</span></span><span style="display:flex;"><span>loco_name <span style="color:#719e07">=</span> rd<span style="color:#719e07">.</span>get_loco_name()      <span style="color:#586e75"># checks if it actually works</span>
</span></span><span style="display:flex;"><span><span style="color:#b58900">print</span>(loco_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>config <span style="color:#719e07">=</span> configparser<span style="color:#719e07">.</span>ConfigParser()
</span></span><span style="display:flex;"><span>config<span style="color:#719e07">.</span>read(<span style="color:#2aa198">&#39;config.ini&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#719e07">try</span>:
</span></span><span style="display:flex;"><span>    keys <span style="color:#719e07">=</span> config[loco_name[<span style="color:#2aa198">1</span>]]
</span></span><span style="display:flex;"><span><span style="color:#719e07">except</span> <span style="color:#cb4b16">TypeError</span> <span style="color:#719e07">as</span> e:
</span></span><span style="display:flex;"><span>    <span style="color:#b58900">print</span>(e)
</span></span><span style="display:flex;"><span>    <span style="color:#b58900">print</span>(<span style="color:#2aa198">&#34;Is train Simulator running correctly?&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#b58900">input</span>(<span style="color:#2aa198">&#39;Press Enter to exit&#39;</span>)
</span></span><span style="display:flex;"><span>    os<span style="color:#719e07">.</span>_exit(<span style="color:#2aa198">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>port_serie <span style="color:#719e07">=</span> Serial(port<span style="color:#719e07">=</span>COM46, baudrate<span style="color:#719e07">=</span><span style="color:#2aa198">115200</span>, timeout<span style="color:#719e07">=</span><span style="color:#2aa198">1</span>, writeTimeout<span style="color:#719e07">=</span><span style="color:#2aa198">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">if</span> port_serie<span style="color:#719e07">.</span>isOpen():
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">while</span> <span style="color:#cb4b16">True</span>:
</span></span><span style="display:flex;"><span>        ligne <span style="color:#719e07">=</span> port_serie<span style="color:#719e07">.</span>readline()<span style="color:#719e07">.</span>rstrip()
</span></span><span style="display:flex;"><span>        rd<span style="color:#719e07">.</span>set_controller_value(keys[<span style="color:#2aa198">&#34;VACMA&#34;</span>], <span style="color:#b58900">float</span>(ligne<span style="color:#719e07">.</span>decode(<span style="color:#2aa198">&#34;utf-8&#34;</span>)))</span></span></code></pre></div>
Le nom des contrôles dépend du matériel utilisé. J&rsquo;utilise donc un fichier .ini, qui contient un <em>mappage</em> entre les termes génériques (ici VACMA) et le terme spécifique au matériel (La VACMA sur AGC, c&rsquo;est <code>CommandeVacma</code> mais sur matériel <em>SimExpress</em> c&rsquo;est <code>vacma_control</code>).</p>
<p>Et avec un peu de chance ça marche. Bon, il faut parfois relancer quelques fois le jeu ou le script, mais à part ça, ça marche !</p>
<h1 id="la-suite">La suite</h1>
<p>Le plus évident pour contrôler un train est le, en language SNCF, ✨ MPT ✨: le ManiPulateur de Traction (en terme TS, <em>Regulator</em>).</p>
<p>Si on ne peut pas avancer, on ne peut pas faire grand chose !</p>
<p><img src="/blog/img/kvb/slide_pot.png" alt="Potentiomètre de côté"></p>
<p>Côté Arduino, je vous laisse regarder sur Internet comment brancher un potentiomètre et lire une valeur analogique, puis la mapper sur 100.
Ensuite, côté PC, c&rsquo;est strictement pareil (j&rsquo;envoie une virgule entre chaque valeur, <em>CSV-style</em>, et après je découpe côté PC).
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    rd<span style="color:#719e07">.</span>set_controller_value(keys[<span style="color:#2aa198">&#34;Regulator&#34;</span>], <span style="color:#b58900">float</span>(args[<span style="color:#2aa198">0</span>]))</span></span></code></pre></div></p>
<h1 id="final">Final</h1>
<p><img src="/blog/img/kvb/plaque.jpg" alt="Plaque de test &amp;ldquo;terminée&amp;rdquo;">
Après m&rsquo;être ratée à gauche sur la découpe, j&rsquo;ai rentré, plus proprement à droite. De gauche à droite:</p>
<ul>
<li>Interrupteur 3 position - inverseur: avancer, neutre, reculer</li>
<li>Bouton vert - Grand Débit: permet de retirer rapidement les freins</li>
<li>Bouton rouge réarmable - Arrêt d&rsquo;urgence</li>
<li>Interrupteur avec protection rouge - Aucun usage, juste pour tester</li>
<li>Potentiomètre vertical qui sert pour le manipulateur de traction</li>
</ul>
</div>

		<p class="meta">Posted on <span class="postdate">04. August 2022</span></p>
	</article>

			</div>

			<footer id="footer">
				<p class="copyright">
					
						Powered by <a href="https://gohugo.io/">Hugo</a> and the
						<a href="https://github.com/bake/solar-theme-hugo">Solar</a>-theme.
					
				</p>
			</footer>
		</div>

		
	</body>
</html>
